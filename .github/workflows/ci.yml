# This is the main CI/CD pipeline for the project.
# It runs linting and testing on 'main' and 'dev' branches.
# It also publishes to TestPyPI on pushes to the 'dev' branch.
name: Main CI/CD Pipeline

on:
  push:
    branches: [ "main", "dev" ]
  pull_request:
    branches: [ "main", "dev" ]

jobs:
  # Job 1: Run linters to check code style
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository code
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install dependencies
        run: pip install pre-commit
      - name: Run pre-commit checks
        run: pre-commit run --all-files

  # Job 2: Run tests across multiple Python versions
  test:
    runs-on: ubuntu-latest
    needs: lint # This job will only start if the 'lint' job succeeds
    strategy:
      fail-fast: false
      matrix:
        python-version: [ "3.10", "3.11", "3.12" ]
    steps:
      - name: Check out repository code
        uses: actions/checkout@v4
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install .
          pip install pytest requests toml
      - name: Test with pytest
        run: pytest -m "not network" # Run all tests EXCEPT the network one

  # Job 3: Check the version before the modification pyproject.toml
  check-version:
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/dev'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - run: |
          pip install pytest requests toml toml-cli

      # We check that the 'dev'-version is available in Testpypi
      - name: Check dev version availability
        run: |
          base_version=$(toml get --toml-path pyproject.toml project.version)
          dev_version="${base_version}.dev${{ github.run_number }}"
          echo "Calculated dev version to check: $dev_version"

          # Temporarily set the dev version to check if it's already published
          echo "Temporarily set the dev version $dev_version in pyproject.toml file
          to check if it's already published ..."
          toml set --toml-path pyproject.toml project.version "$dev_version"

          # Check Testpypi
          echo "Checking if the version is already published on TestPyPI..."
          PYPI_TARGET=testpypi pytest tests/test_publication_to_pipy.py::test_version_is_not_published -v

  # Job 4: Publish to TestPyPI if tests pass, and it's a push to 'dev'
  publish-to-testpypi:
    runs-on: ubuntu-latest
    needs: [test, check-version]  # This job will only start if the 'test' and 'check-version' job succeeds
    # This condition ensures this job ONLY runs on a push to the 'dev' branch
    if: github.event_name == 'push' && github.ref == 'refs/heads/dev'
    steps:
      - name: Check out repository code
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build twine toml-cli
      - name: Bump version for dev build
        run: |
          base_version=$(toml get --toml-path pyproject.toml project.version)
          new_version="${base_version}.dev${{ github.run_number }}"
          echo "Bumping version to ${new_version} for TestPyPI release"
          toml set --toml-path pyproject.toml project.version ${new_version}
      - name: Build package
        run: python -m build
      - name: Publish package to TestPyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.TESTPYPI_API_TOKEN }}
        run: twine upload --repository testpypi dist/*
